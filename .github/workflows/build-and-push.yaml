---
name: Build/Deploy
on:
  push:
    branches: [ master, prod ]

jobs:
  build:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    environment: v4.qubling.cloud
    steps:
    - uses: docker/setup-buildx-action@v3
    - uses: actions/checkout@v5
    - name: Extract Branch Name
      run: "echo $GITHUB_REF | awk -F/ '{{print\"BUILD_PREFIX=\"$3}}' >> $GITHUB_ENV"
    - name: Build Number
      run: echo BUILD_TAG="${{ env.BUILD_PREFIX }}-${{ github.run_number }}.${{ github.run_attempt }}" >> $GITHUB_ENV
    - uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        platforms: linux/amd64,linux/arm64
        tags: ghcr.io/${{ github.repository }}:latest,ghcr.io/${{ github.repository }}:${{ env.BUILD_TAG }}
    - name: Update Build Number
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.S3_BUILD_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_BUILD_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ vars.S3_BUILD_DEFAULT_REGION }}
        AWS_ENDPOINT_URL: ${{ vars.S3_BUILD_ENDPOINT_URL }}
      run: |
        ./set-build-number --env-name ${{ env.BUILD_PREFIX }} periodic-s3-sync ${{ env.BUILD_TAG }}
